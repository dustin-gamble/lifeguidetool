<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Spring 2025 Itinerary</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fdf2f8;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, handle in app */
        }
        /* Custom Scrollbar for the timeline */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #fbcfe8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #f472b6;
        }
        
        .custom-div-icon {
            background: transparent;
            border: none;
        }

        /* Ensure Leaflet containers fill their parent */
        .leaflet-container {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    const { useState, useEffect, useRef, forwardRef, useImperativeHandle } = React;
    
    // --- Icons ---
    const Icons = {
        MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
        Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        Utensils: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>,
        Hotel: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 22v-6.57"/><path d="M12 11h.01"/><path d="M12 7h.01"/><path d="M14 15.43V22"/><path d="M15 16a5 5 0 0 0-6 0"/><path d="M16 11h.01"/><path d="M16 7h.01"/><path d="M8 11h.01"/><path d="M8 7h.01"/><rect x="4" y="2" width="16" height="20" rx="2"/></svg>,
        Link: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
    };

    // --- Rail Data (Approximate Shinkansen Path) ---
    const shinkansenRoute = [
        [35.6812, 139.7671], // Tokyo Station
        [35.5090, 139.6175], // Shin-Yokohama
        [35.2562, 139.1553], // Odawara (Hakone Stop)
        [35.1032, 139.0777], // Atami
        [34.9715, 138.3891], // Shizuoka
        [34.7037, 137.7347], // Hamamatsu
        [34.7697, 137.3829], // Toyohashi
        [35.1709, 136.8815], // Nagoya
        [35.3142, 136.2900], // Maibara (Route curves north around Lake Biwa)
        [34.9858, 135.7588], // Kyoto
        [34.7335, 135.5002], // Shin-Osaka
        [34.6946, 135.1952], // Shin-Kobe
        [34.8279, 134.6919], // Himeji
        [34.6663, 133.9186], // Okayama
        [34.4057, 133.1932], // Onomichi area
        [34.3976, 132.4753]  // Hiroshima
    ];

    // --- Data ---
    const baseTripData = [
        {
            day: 0,
            date: "3/22",
            dow: "SUN",
            loc: "Seattle",
            title: "Departure: SLO to Seattle",
            agenda: "Overnight Seattle Hotel. SBP 7:30pm -> SEA 9:55pm.",
            hotel: "Hilton Seattle Airport",
            coords: [47.4435, -122.2961],
            color: "gray",
            links: [
                { text: "Hilton Seattle Airport", url: "https://www.hilton.com/en/hotels/seatac-hilton-seattle-airport-and-conference-center/" }
            ]
        },
        {
            day: 1,
            date: "3/23",
            dow: "MON",
            loc: "In Transit",
            title: "Fly to Tokyo",
            agenda: "Depart SEA 1:30pm. Cross the International Date Line.",
            hotel: "Airplane",
            coords: null,
            color: "gray"
        },
        {
            day: 2,
            date: "3/24",
            dow: "TUE",
            loc: "Tokyo",
            title: "Arrive in Japan",
            agenda: "Land NRT 4:00pm. Harajuku or Shibuya if energy allows.",
            hotel: "Minn Nihonbashi",
            coords: [35.6841, 139.7746],
            color: "blue",
            links: [
                { text: "Minn Nihonbashi", url: "https://minn.inc/nihonbashi/" }
            ]
        },
        {
            day: 3,
            date: "3/25",
            dow: "WED",
            loc: "Tokyo",
            title: "TeamLabs & Harajuku",
            agenda: "TeamLabs (9am), Shibuya (1pm), Harajuku (3pm), Shinjuku (4:30pm). Pokemon Center, Meiji Shrine.",
            food: "Uobei Sushi, Harajuku Crepes, Ichiran Ramen.",
            hotel: "Tokyo Disney Celebration Hotel",
            coords: [35.6595, 139.7005],
            color: "blue",
            links: [
                { text: "TeamLab Planets (Official)", url: "https://planets.teamlab.art/tokyo/" },
                { text: "Meiji Jingu Shrine", url: "https://www.meijijingu.or.jp/en/" },
                { text: "Shinjuku Gyoen Garden", url: "https://fng.or.jp/shinjuku/en/" },
                { text: "Pokemon Center", url: "https://www.pokemon.co.jp/shop/en/" }
            ]
        },
        {
            day: 4,
            date: "3/26",
            dow: "THU",
            loc: "Tokyo",
            title: "Disney Sea",
            agenda: "All day at Disney Sea.",
            hotel: "Tokyo Disney Celebration Hotel",
            coords: [35.6267, 139.8851],
            color: "blue",
            links: [
                { text: "Tokyo Disney Sea", url: "https://www.tokyodisneyresort.jp/en/tds/" }
            ]
        },
        {
            day: 5,
            date: "3/27",
            dow: "FRI",
            loc: "Tokyo",
            title: "Akihabara & Odaiba",
            agenda: "TeamLab Borderless (Odaiba), Akihabara (Arcades, Gachapon), Ningyocho dinner.",
            food: "Mister Donut, Tenya Tempura, Go! Go! Curry.",
            hotel: "Minn Nihonbashi",
            coords: [35.6984, 139.7731],
            color: "blue",
            links: [
                 { text: "TeamLab Borderless (Official)", url: "https://www.teamlab.art/e/borderless-azabudai/" },
                 { text: "Akihabara Guide", url: "https://www.gotokyo.org/en/destinations/central-tokyo/akihabara/index.html" }
            ]
        },
        {
            day: 6,
            date: "3/28",
            dow: "SAT",
            loc: "Tokyo",
            title: "Ueno & Skytree",
            agenda: "Ueno Park (Cherry Blossoms!), Asakusa (Senso-ji), Tokyo Skytree, Karaoke.",
            hotel: "Minn Nihonbashi",
            coords: [35.7148, 139.7967],
            color: "blue",
            links: [
                { text: "Ueno Park", url: "https://www.gotokyo.org/en/spot/482/" },
                { text: "Senso-ji Temple", url: "https://www.senso-ji.jp/english/" },
                { text: "Tokyo Skytree", url: "https://www.tokyo-skytree.jp/en/" }
            ]
        },
        {
            day: 7,
            date: "3/29",
            dow: "SUN",
            loc: "Hakone",
            title: "RomanceCar to Hakone",
            agenda: "Travel to Hakone. Walk around Lake Ashi, see Mt Fuji. Onsen.",
            food: "Kaiseki Dinner included at Ryokan.",
            hotel: "Lalaca (Gora)",
            coords: [35.2500, 139.0400],
            color: "green",
            links: [
                { text: "RomanceCar Reservations", url: "https://www.hakonenavi.jp/international/en/transportation/romancecar" },
                { text: "Lalaca Ryokan", url: "http://lalaca.com/index-en.html" }
            ]
        },
        {
            day: 8,
            date: "3/30",
            dow: "MON",
            loc: "Kyoto",
            title: "Hakone to Kyoto",
            agenda: "Ropeway, Lake Ashi Boat. Shinkansen to Kyoto.",
            hotel: "Via Inn Prime Kyoto-eki",
            coords: [34.9858, 135.7588],
            color: "purple",
            links: [
                { text: "Hakone Ropeway", url: "https://www.hakoneropeway.co.jp/foreign/en/" },
                { text: "Hakone Sightseeing Cruise", url: "https://www.hakone-kankosen.co.jp/foreign/en/" }
            ]
        },
        {
            day: 9,
            date: "3/31",
            dow: "TUE",
            loc: "Kyoto",
            title: "Old Kyoto",
            agenda: "Kiyomizu-dera, Ninenzaka/Sannenzaka, Gion, Samurai Museum.",
            hotel: "Via Inn Prime Kyoto-eki",
            coords: [34.9949, 135.7850],
            color: "purple",
            links: [
                { text: "Kiyomizu-dera Temple", url: "https://www.kiyomizudera.or.jp/en/" },
                { text: "Samurai & Ninja Museum", url: "https://mai-ko.com/samurai/" }
            ]
        },
        {
            day: 10,
            date: "4/1",
            dow: "WED",
            loc: "Kyoto",
            title: "Bamboo Forest",
            agenda: "Arashiyama Bamboo Forest, Tenryu-ji, Monkey Park.",
            hotel: "Via Inn Prime Kyoto-eki",
            coords: [35.0094, 135.6668],
            color: "purple",
            links: [
                { text: "Arashiyama Bamboo Grove", url: "https://kyoto.travel/en/sightseeing/arashiyama-sagano.html" },
                { text: "Tenryu-ji Temple", url: "http://www.tenryuji.com/en/" },
                { text: "Iwatayama Monkey Park", url: "http://www.monkeypark.jp/" }
            ]
        },
        {
            day: 11,
            date: "4/2",
            dow: "THU",
            loc: "Osaka",
            title: "Kyoto to Osaka",
            agenda: "Optional Nara Deer Park or Osaka Castle. Travel to Osaka evening.",
            hotel: "Hotel Keihan Univ. Tower",
            coords: [34.6654, 135.4323],
            color: "orange",
            links: [
                { text: "Nara Deer Park", url: "https://www.visitnara.jp/venues/A00615/" },
                { text: "Osaka Castle", url: "https://www.osakacastle.net/english/" }
            ]
        },
        {
            day: 12,
            date: "4/3",
            dow: "FRI",
            loc: "Osaka",
            title: "Universal Studios",
            agenda: "USJ All Day. *Mario World Reservation Required*.",
            hotel: "Hotel Keihan Univ. Tower",
            coords: [34.6654, 135.4323],
            color: "orange",
            links: [
                { text: "Universal Studios Japan", url: "https://www.usj.co.jp/web/en/us" },
                { text: "Super Nintendo World", url: "https://www.usj.co.jp/web/en/us/areas/super-nintendo-world" }
            ]
        },
        {
            day: 13,
            date: "4/4",
            dow: "SAT",
            loc: "Hiroshima",
            title: "Peace Park & Okonomiyaki",
            agenda: "Travel to Hiroshima. Peace Museum, A-Bomb Dome, Cherry Blossom Picnic.",
            food: "Yagenbori Hassho (Okonomiyaki) or Nagataya.",
            hotel: "SUNDAY peace room",
            coords: [34.3929, 132.4526],
            color: "red",
            links: [
                { text: "Peace Memorial Museum", url: "https://hpmmuseum.jp/?lang=eng" },
                { text: "Atomic Bomb Dome", url: "https://www.city.hiroshima.lg.jp/site/english/17498.html" },
                { text: "Shukkeien Garden", url: "https://shukkeien.jp/pdf/English_brochure.pdf" }
            ]
        },
        {
            day: 14,
            date: "4/5",
            dow: "SUN",
            loc: "Miyajima",
            title: "Miyajima Island",
            agenda: "Ferry to Miyajima Island. More Okonomiyaki.",
            hotel: "SUNDAY peace room",
            coords: [34.2974, 132.3197],
            color: "red",
            links: [
                { text: "Miyajima Tourist Info", url: "https://www.miyajima.or.jp/english/" },
                { text: "Itsukushima Shrine", url: "http://www.itsukushimajinja.jp/index.html" }
            ]
        },
        {
            day: 15,
            date: "4/6",
            dow: "MON",
            loc: "Home",
            title: "Return Home",
            agenda: "Hiroshima -> Tokyo (NRT) -> Seattle -> SLO.",
            hotel: "Home Sweet Home",
            coords: [35.7719, 140.3929],
            color: "gray"
        },
    ];

    // --- Food & Travel Enrichment ---
    const foodSuggestionsByDay = {
        0: [
            "Ivar's clam chowder at SEA",
            "Beecher's mac & cheese cups",
            "Din Tai Fung dumplings (Concourse S)",
            "Skillet Counter breakfast sandwich",
            "Caffe Vita cold brew"
        ],
        1: [
            "Capitol Hill Food Hall poke bowls to-go",
            "Lucky Louie smoked salmon bagel",
            "Dish D'Lish picnic box for the flight",
            "Floret veggie grain bowl",
            "Fran's sea salt caramels"
        ],
        2: [
            "Tendon Kaneko Hannosuke tempura bowls",
            "Gyukatsu Motomura Nihonbashi",
            "Ningyocho Imahan sukiyaki lunch",
            "Muromachi Sunaba soba",
            "Taiyaki Wakaba red bean cones"
        ],
        3: [
            "Afuri yuzu ramen in Harajuku",
            "Luke's Lobster rolls (Omotesando)",
            "Uobei conveyor-belt sushi",
            "Gyukatsu Motomura Shibuya",
            "Calbee+ hot potato chips"
        ],
        4: [
            "Magellan's at DisneySea",
            "Ristorante di Canaletto pizza & pasta",
            "Sebastian's Calypso Kitchen gyoza dog",
            "Zambini Brothers pasta bowls",
            "Mamma Biscotti's bakery treats"
        ],
        5: [
            "Tsurutontan Udon Odaiba",
            "Ippudo Express ramen at DiverCity",
            "Go! Go! Curry Akihabara",
            "Tonkatsu Marugo (Akihabara)",
            "Maidreamin parfait dessert"
        ],
        6: [
            "Asakusa Kagetsudo melon pan",
            "Ningyo-yaki stalls by Senso-ji",
            "Daikokuya tempura tendon",
            "Solamachi Ramen Yokocho picks",
            "Ameyoko yakitori alley skewers"
        ],
        7: [
            "Owakudani black eggs",
            "Hakone Bakery curry buns",
            "Gora Brewery & Grill pizza",
            "Amazake Chaya sweet rice drink",
            "Lake Ashi wakasagi tempura"
        ],
        8: [
            "Ramen Koji food court (Kyoto Station)",
            "Musashi sushi conveyor at the station",
            "Nakamura Tokichi matcha parfait",
            "Kyoto Tower Sando bakery bites",
            "Yatsuhashi gift shop samples"
        ],
        9: [
            "% Arabica Higashiyama espresso",
            "Yasaka Endo tempura lunch",
            "Nishiki Market soy donuts",
            "Gion Kinana matcha ice cream",
            "Pontocho yakitori at Torito"
        ],
        10: [
            "Arashiyama Yoshimura soba by the river",
            "Kameya mame-mochi snacks",
            "Bamboo grove croquettes street-side",
            "Yudofu Sagano tofu hotpot",
            "Matcha soft serve from Nonomiya Tea House"
        ],
        11: [
            "Takoyaki at Creo-ru Dotonbori",
            "Okonomiyaki at Mizuno",
            "Kushikatsu Daruma skewers",
            "551 Horai pork buns",
            "Rikuro Ojisan cheesecake"
        ],
        12: [
            "Butterbeer at Hogsmeade",
            "Kinopio's Cafe Superstar rice",
            "Mel's Drive-In burgers & shakes",
            "Minion Park banana popcorn",
            "Amity Landing shrimp roll"
        ],
        13: [
            "Okonomiyaki at Nagataya",
            "Hiroshima oysters at Ekie Kaisen",
            "Hassho okonomiyaki with squid",
            "Bakudanya spicy tsukemen",
            "Momiji manju at Nishiki-do"
        ],
        14: [
            "Grilled oysters on the pier",
            "Anago-meshi eel rice box",
            "Deep-fried momiji manju",
            "Umegae mochi warm rice cakes",
            "Sea-salt soft serve by the ferry"
        ],
        15: [
            "Saboten tonkatsu bento at NRT",
            "Narita Dining Terrace kaisen don",
            "Lawson karaage-kun chicken bites",
            "Royce' nama chocolate to-go",
            "Starbucks Reserve coffee before boarding"
        ]
    };

    const travelTimeByDay = {
        0: "SBP â†’ SEA flight: ~2h 30m",
        1: "SEA â†’ Tokyo (NRT): ~10h 30m flight",
        2: "Narita Express to Nihonbashi: ~1h",
        3: "Shibuya/Harajuku transfers: 20-30m between stops",
        4: "Into DisneySea area from central Tokyo: ~45m",
        5: "Resort to Odaiba/Akihabara hops: ~35-45m",
        6: "Asakusa, Ueno, and Skytree hops: 10-25m each",
        7: "Tokyo â†’ Hakone (RomanceCar): ~1h 25m",
        8: "Hakone â†’ Kyoto via Odawara Shinkansen: ~2h",
        9: "Higashiyama to Gion loop: 10-15m walking",
        10: "Kyoto â†’ Arashiyama: ~25m by JR/Randen",
        11: "Kyoto â†’ Osaka: ~15m Shinkansen (~30m JR)",
        12: "Osaka/Umeda â†’ Universal City: ~15m train",
        13: "Shin-Osaka â†’ Hiroshima: ~1h 35m Shinkansen",
        14: "Hiroshima â†’ Miyajima: ~45m (train + ferry)",
        15: "Hiroshima â†’ Tokyo/NRT â†’ SEA â†’ SBP: ~12h total"
    };

    const tripData = baseTripData.map(stop => ({
        ...stop,
        foodSuggestions: foodSuggestionsByDay[stop.day] || [],
        travelTime: travelTimeByDay[stop.day] || null
    }));

    // --- Components ---

    const TripCard = ({ item, isLast, isActive, onClick }) => {
        const mapLink = item.coords ? `https://www.google.com/maps?q=${item.coords[0]},${item.coords[1]}` : null;
        const hasLinks = (item.links && item.links.length > 0) || mapLink;

        const getBgColor = (loc, active) => {
            if (active) return "bg-pink-100 border-pink-400 ring-2 ring-pink-300";
            if (loc === "Tokyo") return "bg-blue-50 border-blue-200 hover:bg-blue-100";
            if (loc === "Hakone") return "bg-green-50 border-green-200 hover:bg-green-100";
            if (loc === "Kyoto") return "bg-purple-50 border-purple-200 hover:bg-purple-100";
            if (loc === "Osaka") return "bg-orange-50 border-orange-200 hover:bg-orange-100";
            if (loc === "Hiroshima" || loc === "Miyajima") return "bg-red-50 border-red-200 hover:bg-red-100";
            return "bg-gray-50 border-gray-200 hover:bg-gray-100";
        };

        const getBadgeColor = (loc) => {
            if (loc === "Tokyo") return "bg-blue-100 text-blue-800";
            if (loc === "Hakone") return "bg-green-100 text-green-800";
            if (loc === "Kyoto") return "bg-purple-100 text-purple-800";
            if (loc === "Osaka") return "bg-orange-100 text-orange-800";
            if (loc === "Hiroshima" || loc === "Miyajima") return "bg-red-100 text-red-800";
            return "bg-gray-200 text-gray-800";
        };

        return (
            <div
                className="flex gap-4 mb-6 relative cursor-pointer group"
                onClick={onClick}
            >
                {/* Timeline Line */}
                {!isLast && <div className="absolute left-[2.25rem] top-12 bottom-[-1.5rem] w-0.5 border-l-2 border-dashed border-gray-300 group-hover:border-pink-300 transition-colors"></div>}
                
                {/* Date Bubble */}
                <div className="flex-shrink-0 w-20 flex flex-col items-center">
                    <div className={`w-16 h-16 rounded-full border-4 flex flex-col items-center justify-center shadow-sm z-10 transition-all ${isActive ? 'bg-pink-50 border-pink-400 scale-110' : 'bg-white border-pink-200 group-hover:border-pink-300'}`}>
                        <span className="text-xs font-bold text-gray-500">{item.dow}</span>
                        <span className="text-sm font-bold text-pink-600">{item.date}</span>
                    </div>
                </div>

                {/* Content Card */}
                <div className={`flex-grow rounded-xl border p-5 shadow-sm transition-all duration-300 ${getBgColor(item.loc, isActive)}`}>
                    <div className="flex justify-between items-start mb-2">
                        <h3 className="font-bold text-lg text-gray-800">{item.title}</h3>
                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${getBadgeColor(item.loc)}`}>
                            {item.loc}
                        </span>
                    </div>
                    
                    <div className="space-y-3 text-sm text-gray-700">
                        <p className="flex gap-2">
                            <span className="mt-0.5 text-gray-400"><Icons.MapPin /></span>
                            <span>{item.agenda}</span>
                        </p>

                        {item.travelTime && (
                            <p className="flex gap-2 text-xs sm:text-sm text-gray-600">
                                <span className="mt-0.5 text-gray-400"><Icons.Clock /></span>
                                <span><span className="font-semibold text-gray-700">Travel time:</span> {item.travelTime}</span>
                            </p>
                        )}
                        
                        {item.food && (
                            <p className="flex gap-2 text-emerald-700 bg-emerald-50 p-2 rounded-lg">
                                <span className="mt-0.5"><Icons.Utensils /></span>
                                <span className="italic">{item.food}</span>
                            </p>
                        )}

                        {isActive && item.foodSuggestions?.length > 0 && (
                            <div className="border border-emerald-100 bg-white/70 rounded-lg p-3">
                                <div className="flex items-center gap-2 text-emerald-800 font-semibold mb-2">
                                    <Icons.Utensils />
                                    <span>Food ideas nearby</span>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {item.foodSuggestions.map((food, idx) => (
                                        <span
                                            key={idx}
                                            className="px-2 py-1 bg-emerald-50 border border-emerald-200 rounded-full text-xs text-emerald-700"
                                        >
                                            {food}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {hasLinks && (
                            <div className="flex flex-wrap gap-2 mt-2 pt-2 border-t border-gray-200/50">
                                {mapLink && (
                                    <a
                                        href={mapLink}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        onClick={(e) => e.stopPropagation()}
                                        className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium text-pink-600 hover:bg-pink-50 hover:border-pink-200 transition-colors"
                                    >
                                        <Icons.MapPin />
                                        View {item.loc} map
                                    </a>
                                )}
                                {item.links?.map((link, idx) => (
                                    <a
                                        key={idx}
                                        href={link.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        onClick={(e) => e.stopPropagation()} // Prevent card click when clicking link
                                        className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium text-pink-600 hover:bg-pink-50 hover:border-pink-200 transition-colors"
                                    >
                                        <Icons.Link />
                                        {link.text}
                                    </a>
                                ))}
                            </div>
                        )}

                        <p className="flex gap-2 text-gray-500 border-t border-gray-200 pt-2 mt-2">
                            <span className="mt-0.5"><Icons.Hotel /></span>
                            <span className="font-medium">{item.hotel}</span>
                        </p>
                    </div>
                </div>
            </div>
        );
    };

    const MapView = forwardRef(({ data, activeView, activeDay }, ref) => {
        const mapContainerRef = useRef(null);
        const mapInstance = useRef(null);
        const markersRef = useRef({}); // Store references to markers by day index
        const [mapReady, setMapReady] = useState(false);

        const buildPopupContent = (stop) => {
            const foodList = stop.foodSuggestions?.length
                ? `<div style="margin-top:6px;font-weight:600;color:#065f46;">Food picks</div><ul style="margin:4px 0 0;padding-left:18px;color:#065f46;">${stop.foodSuggestions.map(f => `<li>${f}</li>`).join('')}</ul>`
                : '';
            const travelLine = stop.travelTime
                ? `<div style="margin-top:6px;font-weight:600;color:#374151;">Travel: <span style="font-weight:500;color:#111827;">${stop.travelTime}</span></div>`
                : '';

            return `
                <div style="min-width: 200px">
                    <div style="font-weight:700;color:#111827;">${stop.date} - ${stop.loc}</div>
                    <div style="margin-top:2px;color:#4b5563;">${stop.title}</div>
                    ${travelLine}
                    ${foodList}
                </div>
            `;
        };

        const focusStop = (stop, options = {}) => {
            if (!mapInstance.current || !stop?.coords) return;

            const marker = markersRef.current[stop.day];
            if (marker) {
                marker.openPopup();
            }

            const zoomLevel = options.zoom || 12;
            const duration = options.duration ?? 1.5;

            mapInstance.current.flyTo(stop.coords, zoomLevel, {
                animate: true,
                duration
            });
        };

        useImperativeHandle(ref, () => ({
            focusStop
        }));

        useEffect(() => {
            if (!mapContainerRef.current) return;

            // Initialize map only once
            if (!mapInstance.current) {
                const map = L.map(mapContainerRef.current).setView([35.3606, 138.7274], 6);
                mapInstance.current = map;

                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                // --- 1. PLOT STOPS/MARKERS ---
                data.forEach(stop => {
                    if (stop.coords) {
                        const markerColor = stop.color === 'blue' ? '#3b82f6' :
                                          stop.color === 'green' ? '#22c55e' :
                                          stop.color === 'purple' ? '#a855f7' :
                                          stop.color === 'orange' ? '#f97316' :
                                          stop.color === 'red' ? '#ef4444' : '#6b7280';
                        
                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${markerColor}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        });

                        const marker = L.marker(stop.coords, { icon: customIcon })
                         .addTo(map)
                         .bindPopup(buildPopupContent(stop));
                        
                         // Store marker reference
                         markersRef.current[stop.day] = marker;
                    }
                });

                // --- 2. PLOT SHINKANSEN ROUTE ---
                L.polyline(shinkansenRoute, {
                    color: '#2563eb', // Blue for Rail
                    weight: 4,
                    opacity: 0.8
                }).addTo(map);
                
                L.polyline(shinkansenRoute, {
                    color: 'white',
                    weight: 2,
                    opacity: 0.5,
                    dashArray: '5, 10'
                }).addTo(map);

                // --- 3. FLIGHT PATHS ---
                const flightPath = [
                    [47.4435, -122.2961], // Seattle
                    [35.6841, 139.7746]   // Tokyo
                ];
                
                L.polyline(flightPath, {
                    color: '#9ca3af',
                    weight: 2,
                    opacity: 0.6,
                    dashArray: '4, 8'
                }).addTo(map);

                setMapReady(true);
            }
            
            // Fix map size when switching views or resizing
            if(mapInstance.current) {
                setTimeout(() => {
                    mapInstance.current.invalidateSize();
                }, 100);
            }
        }, [data, activeView]);

        // Effect to handle zooming to active day
        useEffect(() => {
            if (!mapReady || !activeDay || !activeDay.coords) return;

            // If on mobile, wait a bit for the view transition
            const isMobile = window.innerWidth < 1024;
            const delay = isMobile ? 300 : 0;

            const timer = setTimeout(() => {
                focusStop(activeDay);
            }, delay);

            return () => clearTimeout(timer);
        }, [activeDay, mapReady]);

        return <div ref={mapContainerRef} className="w-full h-full bg-gray-100"></div>;
    });

    const App = () => {
        const [view, setView] = useState('itinerary');
        const [activeDay, setActiveDay] = useState(null);
        const mapRef = useRef(null);

        const handleSelectDay = (item) => {
            setActiveDay(item);

            if (mapRef.current) {
                mapRef.current.focusStop(item);
            }

            // On mobile, switch to map view when clicking a card
            if (window.innerWidth < 1024 && item.coords) {
                setView('map');
            }
        };

        return (
            <div className="h-screen flex flex-col bg-white overflow-hidden">
                {/* Header */}
                <header className="bg-gradient-to-r from-pink-500 to-rose-400 p-4 lg:p-6 text-white shrink-0 shadow-lg z-20 flex justify-between items-center">
                    <div>
                        <h1 className="text-xl lg:text-2xl font-bold flex items-center gap-2">
                            ðŸŒ¸ Japan Trip 2025
                        </h1>
                        <p className="text-pink-100 text-xs lg:text-sm mt-1">March 22 - April 6 â€¢ 15 Days</p>
                    </div>
                    <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm hidden sm:block">
                        <span className="font-bold text-lg">15</span>
                        <span className="text-xs block text-center">Days</span>
                    </div>
                </header>

                {/* Mobile Tabs (Hidden on Desktop) */}
                <div className="flex border-b border-gray-200 shrink-0 bg-white z-10 lg:hidden">
                    <button
                        onClick={() => setView('itinerary')}
                        className={`flex-1 py-3 text-sm font-medium transition-colors duration-200 ${view === 'itinerary' ? 'text-pink-600 border-b-2 border-pink-600 bg-pink-50' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                        Daily Itinerary
                    </button>
                    <button
                        onClick={() => setView('map')}
                        className={`flex-1 py-3 text-sm font-medium transition-colors duration-200 ${view === 'map' ? 'text-pink-600 border-b-2 border-pink-600 bg-pink-50' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                        Map View
                    </button>
                </div>

                {/* Main Content: Split Screen on Desktop, Tabbed on Mobile */}
                <div className="flex-grow flex flex-col lg:flex-row overflow-hidden relative bg-[#fdf2f8]">
                    
                    {/* LEFT COLUMN: Itinerary */}
                    <div className={`
                        h-full overflow-y-auto bg-[#fdf2f8] scroll-smooth
                        ${view === 'itinerary' ? 'block' : 'hidden'} 
                        lg:block lg:w-1/2 lg:border-r border-gray-200 lg:shadow-xl z-10
                    `}>
                        <div className="max-w-xl mx-auto p-4 md:p-8">
                            {tripData.map((item, index) => (
                                <TripCard
                                    key={index}
                                    item={item}
                                    isLast={index === tripData.length - 1}
                                    isActive={activeDay?.day === item.day}
                                    onClick={() => handleSelectDay(item)}
                                />
                            ))}
                            
                            <div className="mt-8 bg-white p-6 rounded-xl border border-gray-200 shadow-sm text-center mb-8">
                                <h3 className="font-bold text-gray-800 mb-2">Important Notes</h3>
                                <ul className="text-sm text-gray-600 space-y-2 text-left list-disc pl-5">
                                    <li>Get <strong>Mario World Reservation</strong> for Day 12 (USJ) in advance!</li>
                                    <li>Send large bags from Tokyo to Kyoto on Day 7.</li>
                                    <li>Eat Okonomiyaki in Hiroshima!</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    {/* RIGHT COLUMN: Map */}
                    <div className={`
                        h-full relative
                        ${view === 'map' ? 'block' : 'hidden'} 
                        lg:block lg:w-1/2
                    `}>
                        <MapView ref={mapRef} data={tripData} activeView={view} activeDay={activeDay} />
                    </div>

                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>

</body>
</html>
